# rpc&websockets 

* 参考：https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API

架构图：

![rpc](./imgs/rpc.png)



# 寻址

## 分布式系统如何寻址

https://zhuanlan.zhihu.com/p/271693538

https://blog.csdn.net/zhizhengguan/article/details/121430872

* 分布式系统通过 rpc 实现网络通信

通过 RPC 框架，能够解决服务之间的跨网络通信问题，是微服务改造的基础。

服务拆分之后，需要维护更多细粒度的服务，这样就涉及到 RPC 客户端服到服务端的 部署地址问题，如何维护？ 这个时候就需要服务注册和发现。

* 寻址方式就是服务注册和发现。

### 服务发现

> 所谓的服务发现，就是让服务调用方知道服务提供方的地址是啥？ 比如 Ngnix 作为反向代理器，可以这样当请求到来时，可以通过 nginx 知道应用服务器的地址是什么。这个就叫：**服务发现**。

* 调用方知道服务提供方地址

### Nginx 服务发现

* 主要把服务提供方的地址写死到配置文件中

主要问题：

- 需要扩容的时候，需要修改客户端配置，重启客户端进程，操作起来比较麻烦。
- 一旦一个服务器出故障，需要修改配置，然后重启，无法自动修复
- RPC 服务端上线无法提前摘除流量，也就是说，发往服务端的请求流量依然会存在，客户端被重启服务端的请求还没有返回，会造成客户端请求失败。

### 注册中心怎么解决这些问题？

注册中心两点功能：

- 提供服务地址的存储
- 当存储内容发生变化时，可以将变更的内容推送给客户端

有了第二个内容，当需要紧急扩容时，当服务器发生故障时，需要快速摘除节点，都不用重启就可以实现。

* 主要是服务地址注册（也就存储服务地址）；存储内容变化，进行通知，发送给客户端；

![img](https://pic4.zhimg.com/80/v2-f830f8268d29525467c1194e50d78cf3_1440w.webp)

流程说明：

- 客户端与注册中心建立连接，告诉注册中心。
- 服务端向注册中心注册服务后，注册中心会将最新的服务注册信息通知给客户端。
- 客户端拿到服务端的地址之后，就可以向服务端发起调用请求。

==服务端的增加减少对于客户端来说是透明的==，这样可以实现不重启客户端，就可以动态地变更服务节点，并且实现优雅关机。

### 优雅关机

优雅关机的相对面是暴力关机，暴力停止服务，已经发送的请求还没有来得及处理，就被杀掉，这样会造成部分请求失败。因此需要在服务端退出的时候，先停止掉流量，不再受理新的请求，当服务处理完之后再关闭。
