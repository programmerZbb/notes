# 架构

参考：https://www.cnblogs.com/ihardcoder/p/14778013.html

## 怎么设计

1. 限制标签类型，并不需要所有的标签，通过框架限制标签类型
2. 安全性：需要设计一个类似于浏览器 worker 的独立线程，不能直接操作 DOM，只能通过数据驱动。

## 双线程模型

> 渲染线程使用 Webview 进行 UI 的渲染呈现。Webview 是一个完整的类浏览器运行环境，本身具备运行 JavaScript 的能力，但是小程序并不是将逻辑脚本放到 Webview 中运行，而是将逻辑层独立为一个与 Webview 平行的线程，使用客户端提供的 JavaScript 引擎运行代码，iOS 的JavaScriptCore、安卓是腾讯 X5 内核提供的 JsCore 环境以及 IDE 工具的 nwjs 。

![img](https://img2020.cnblogs.com/blog/595796/202105/595796-20210517181813421-1609752624.png)

小程序采用了双线程模型，webview 负责渲染UI——渲染线程，逻辑线程是由客户端提供的js引擎提供的。

## 事件驱动的通信方式

> 注意上图渲染线程和逻辑线程之间的通信方式，与 Vue/React 不同的是，小程序的渲染层与逻辑层之间的通信并不是在两者之间直接传递数据或事件，而是**由 Native 作为中间媒介进行转发**。
>
> **整个过程是典型的事件驱动模式：**
>
> - 渲染层（也可以称为视图层）通过与用户的交互触发特定的事件 event；
> - 然后 event 被传递给逻辑层；
> - 逻辑层继而通过一系列的逻辑处理、数据请求、接口调用等行为将加工好的数据 data 传递给渲染层；
> - 最后渲染层将 data 渲染为可视化的 UI。
>
> 这种数据驱动 UI 的模式是现在前端编程领域较为推崇的编程范式，如果你是一个超过 5 年开发经验的前端开发者的话，那么我相信在最初接触到这种模式的时候肯定有一些不适应，因为在此之前 JavaScript 操作 DOM 几乎是一种“业内规则”，甚至有不少针对前端入门的图书、博客和教材都是先从 DOM 操作讲起，现在看来这些确实有些不合时宜了。

* 由 native 作为媒介进行通信
* 这种方式非常像 `react + mobx` 项目的方式，数据完全在 store 中流转，渲染层的 js 只提供了根据数据渲染页面的框架。

